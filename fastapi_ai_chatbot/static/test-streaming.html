<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Streaming</title>
</head>
<body>
    <h1>Streaming Test</h1>
    <div>
        <button id="test-streaming">Test Streaming</button>
        <button id="get-chatbots">Get Chatbots</button>
        <button id="create-session">Create Session</button>
    </div>
    
    <div id="results" style="white-space: pre-wrap; font-family: monospace; margin-top: 20px; border: 1px solid #ccc; padding: 10px; height: 400px; overflow-y: auto;"></div>

    <script>
        const resultsDiv = document.getElementById('results');
        
        function log(message) {
            resultsDiv.textContent += new Date().toISOString() + ' - ' + message + '\n';
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        // Test getting chatbots
        document.getElementById('get-chatbots').addEventListener('click', async () => {
            log('Testing chatbots API...');
            try {
                const response = await fetch('/api/chatbots/');
                const chatbots = await response.json();
                log('Chatbots response: ' + JSON.stringify(chatbots, null, 2));
                window.testChatbots = chatbots;
            } catch (error) {
                log('Error getting chatbots: ' + error.message);
            }
        });
        
        // Test creating session
        document.getElementById('create-session').addEventListener('click', async () => {
            log('Testing session creation...');
            if (!window.testChatbots || window.testChatbots.length === 0) {
                log('Please get chatbots first');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/sessions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        chatbot_id: window.testChatbots[0].id
                    })
                });
                const session = await response.json();
                log('Session created: ' + JSON.stringify(session, null, 2));
                window.testSession = session;
            } catch (error) {
                log('Error creating session: ' + error.message);
            }
        });
        
        // Test streaming
        document.getElementById('test-streaming').addEventListener('click', async () => {
            log('Testing streaming...');
            if (!window.testSession) {
                log('Please create a session first');
                return;
            }
            
            try {
                const response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        session_id: window.testSession.id,
                        message: 'Hello, this is a test message'
                    })
                });
                
                log('Response status: ' + response.status);
                log('Response headers: ' + JSON.stringify([...response.headers.entries()]));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log('Error response: ' + errorText);
                    return;
                }
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                
                log('Starting to read stream...');
                
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) {
                        log('Stream finished');
                        break;
                    }
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';
                    
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const dataStr = line.slice(6).trim();
                            log('SSE data: ' + dataStr);
                            
                            if (dataStr === '[DONE]') {
                                log('Stream completed with [DONE]');
                                return;
                            }
                            
                            if (dataStr) {
                                try {
                                    const event = JSON.parse(dataStr);
                                    log('Parsed event: ' + JSON.stringify(event));
                                } catch (err) {
                                    log('Error parsing event: ' + err.message);
                                }
                            }
                        } else if (line.trim()) {
                            log('Non-SSE line: ' + line);
                        }
                    }
                }
                
            } catch (error) {
                log('Streaming error: ' + error.message);
                log('Error stack: ' + error.stack);
            }
        });
    </script>
</body>
</html>